<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Certificates - Sci-Bono AI Fluency</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    <style>
        .certificates-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .page-header {
            text-align: center;
            margin-bottom: 3rem;
        }

        .page-header h1 {
            font-size: 2.5rem;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }

        .page-header p {
            font-size: 1.1rem;
            color: var(--text-color);
        }

        .certificates-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 2rem;
            margin-bottom: 3rem;
        }

        .certificate-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--shadow);
            transition: var(--transition);
        }

        .certificate-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .certificate-preview {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            padding: 2rem;
            color: white;
            text-align: center;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .certificate-preview i {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.9;
        }

        .certificate-preview h3 {
            font-size: 1.3rem;
            margin-bottom: 0.5rem;
        }

        .certificate-preview .cert-type {
            font-size: 0.9rem;
            opacity: 0.8;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .certificate-info {
            padding: 1.5rem;
        }

        .cert-number {
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 0.5rem;
            font-family: monospace;
        }

        .cert-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }

        .cert-description {
            font-size: 0.9rem;
            color: var(--text-color);
            margin-bottom: 1rem;
        }

        .cert-date {
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 1rem;
        }

        .cert-actions {
            display: flex;
            gap: 0.5rem;
        }

        .cert-btn {
            flex: 1;
            padding: 0.75rem;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .cert-btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .cert-btn-primary:hover {
            background: var(--secondary-color);
        }

        .cert-btn-secondary {
            background: var(--background-light);
            color: var(--primary-color);
        }

        .cert-btn-secondary:hover {
            background: #e0e0e0;
        }

        .no-certificates {
            text-align: center;
            padding: 4rem 2rem;
            background: white;
            border-radius: 12px;
            box-shadow: var(--shadow);
        }

        .no-certificates i {
            font-size: 4rem;
            color: #ddd;
            margin-bottom: 1rem;
        }

        .no-certificates h2 {
            color: var(--primary-color);
            margin-bottom: 1rem;
        }

        .no-certificates p {
            color: var(--text-color);
            margin-bottom: 1.5rem;
        }

        .no-certificates .btn {
            display: inline-block;
            padding: 0.75rem 1.5rem;
            background: var(--primary-color);
            color: white;
            text-decoration: none;
            border-radius: 8px;
            transition: var(--transition);
        }

        .no-certificates .btn:hover {
            background: var(--secondary-color);
        }

        .verify-section {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: var(--shadow);
            margin-top: 3rem;
        }

        .verify-section h2 {
            color: var(--primary-color);
            margin-bottom: 1rem;
        }

        .verify-form {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .verify-form input {
            flex: 1;
            padding: 0.75rem;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            font-family: monospace;
        }

        .verify-form button {
            padding: 0.75rem 2rem;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: var(--transition);
        }

        .verify-form button:hover {
            background: var(--secondary-color);
        }

        .verify-result {
            margin-top: 1.5rem;
            padding: 1rem;
            border-radius: 8px;
        }

        .verify-result.valid {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .verify-result.invalid {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .verify-result h3 {
            margin-bottom: 0.5rem;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
            z-index: 10;
        }

        .certificate-full {
            padding: 3rem;
            text-align: center;
        }

        @media (max-width: 768px) {
            .certificates-container {
                padding: 1rem;
            }

            .certificates-grid {
                grid-template-columns: 1fr;
            }

            .verify-form {
                flex-direction: column;
            }

            .modal-content {
                margin: 1rem;
            }

            .certificate-full {
                padding: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <div id="header-container"></div>

    <div class="certificates-container">
        <div class="page-header">
            <h1><i class="fas fa-certificate"></i> My Certificates</h1>
            <p>View and download your earned certificates</p>
        </div>

        <div id="certificates-grid" class="certificates-grid">
            <div class="loading" style="grid-column: 1 / -1; text-align: center; padding: 3rem;">
                <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: var(--primary-color);"></i>
                <p>Loading your certificates...</p>
            </div>
        </div>

        <div class="verify-section">
            <h2><i class="fas fa-shield-check"></i> Verify a Certificate</h2>
            <p>Enter a certificate number to verify its authenticity</p>
            <div class="verify-form">
                <input
                    type="text"
                    id="verify-input"
                    placeholder="e.g., SCIBONO-2025-A3F7B2"
                    maxlength="50"
                >
                <button id="verify-btn">
                    <i class="fas fa-search"></i> Verify
                </button>
            </div>
            <div id="verify-result"></div>
        </div>
    </div>

    <div id="certificate-modal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeCertificateModal()">
                <i class="fas fa-times"></i>
            </button>
            <div id="certificate-full-view"></div>
        </div>
    </div>

    <div id="footer-container"></div>

    <script src="js/storage.js"></script>
    <script src="js/api.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/header-template.js"></script>
    <script src="js/footer-template.js"></script>

    <script>
        // Check authentication
        if (!isAuthenticated()) {
            window.location.href = 'login.html';
        }

        // Load user certificates
        async function loadCertificates() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/certificates/user', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to load certificates');
                }

                const data = await response.json();
                renderCertificates(data.certificates || []);
            } catch (error) {
                console.error('Error loading certificates:', error);
                document.getElementById('certificates-grid').innerHTML = `
                    <div class="error" style="grid-column: 1 / -1; text-align: center; padding: 3rem;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 2rem; color: var(--accent-color);"></i>
                        <p>Failed to load certificates. Please try again later.</p>
                    </div>
                `;
            }
        }

        function renderCertificates(certificates) {
            const grid = document.getElementById('certificates-grid');

            if (certificates.length === 0) {
                grid.innerHTML = `
                    <div class="no-certificates" style="grid-column: 1 / -1;">
                        <i class="fas fa-certificate"></i>
                        <h2>No Certificates Yet</h2>
                        <p>Complete courses and modules to earn certificates!</p>
                        <a href="/student-dashboard.html" class="btn">Go to Dashboard</a>
                    </div>
                `;
                return;
            }

            grid.innerHTML = certificates.map(cert => {
                const issueDate = new Date(cert.issue_date).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });

                const typeIcons = {
                    'course_completion': 'fa-graduation-cap',
                    'module_completion': 'fa-book',
                    'quiz_achievement': 'fa-trophy',
                    'custom': 'fa-award'
                };

                const icon = typeIcons[cert.certificate_type] || 'fa-certificate';

                return `
                    <div class="certificate-card">
                        <div class="certificate-preview">
                            <i class="fas ${icon}"></i>
                            <h3>${escapeHtml(cert.title)}</h3>
                            <div class="cert-type">${cert.certificate_type.replace('_', ' ')}</div>
                        </div>
                        <div class="certificate-info">
                            <div class="cert-number">
                                <i class="fas fa-fingerprint"></i> ${escapeHtml(cert.certificate_number)}
                            </div>
                            ${cert.description ? `
                                <div class="cert-description">${escapeHtml(cert.description)}</div>
                            ` : ''}
                            <div class="cert-date">
                                <i class="fas fa-calendar"></i> Issued: ${issueDate}
                            </div>
                            <div class="cert-actions">
                                <button class="cert-btn cert-btn-primary" onclick="viewCertificate(${cert.id})">
                                    <i class="fas fa-eye"></i> View
                                </button>
                                <button class="cert-btn cert-btn-secondary" onclick="downloadCertificate(${cert.id})">
                                    <i class="fas fa-download"></i> Download
                                </button>
                                <button class="cert-btn cert-btn-secondary" onclick="shareCertificate('${cert.certificate_number}')">
                                    <i class="fas fa-share"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function viewCertificate(certId) {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/certificates/${certId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to load certificate');
                }

                const data = await response.json();
                const cert = data.certificate;

                document.getElementById('certificate-full-view').innerHTML = `
                    <div class="certificate-full">
                        <h1 style="color: var(--primary-color); margin-bottom: 2rem;">
                            ${escapeHtml(cert.title)}
                        </h1>
                        <p style="font-size: 1.2rem; margin-bottom: 1rem;">
                            This certifies that
                        </p>
                        <h2 style="font-size: 2rem; color: var(--primary-color); margin-bottom: 2rem;">
                            ${escapeHtml(cert.student_name || 'Student')}
                        </h2>
                        <p style="margin-bottom: 2rem;">
                            ${escapeHtml(cert.description || 'Has successfully completed the requirements')}
                        </p>
                        <div style="margin-top: 3rem; padding-top: 2rem; border-top: 2px solid #ddd;">
                            <p><strong>Certificate Number:</strong> ${escapeHtml(cert.certificate_number)}</p>
                            <p><strong>Issue Date:</strong> ${new Date(cert.issue_date).toLocaleDateString()}</p>
                        </div>
                    </div>
                `;

                document.getElementById('certificate-modal').classList.add('active');
            } catch (error) {
                console.error('Error viewing certificate:', error);
                alert('Failed to load certificate details');
            }
        }

        function closeCertificateModal() {
            document.getElementById('certificate-modal').classList.remove('active');
        }

        async function downloadCertificate(certId) {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/certificates/${certId}/download`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to download certificate');
                }

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `certificate-${certId}.pdf`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                a.remove();
            } catch (error) {
                console.error('Error downloading certificate:', error);
                alert('Certificate download is not yet available. Please check back later.');
            }
        }

        function shareCertificate(certNumber) {
            const verifyUrl = `${window.location.origin}/certificates.html?verify=${certNumber}`;

            if (navigator.share) {
                navigator.share({
                    title: 'My Certificate - Sci-Bono AI Fluency',
                    text: `Check out my certificate! Verify it here: ${certNumber}`,
                    url: verifyUrl
                }).catch(err => console.log('Error sharing:', err));
            } else {
                navigator.clipboard.writeText(verifyUrl).then(() => {
                    alert('Verification link copied to clipboard!');
                }).catch(() => {
                    alert(`Verification URL: ${verifyUrl}`);
                });
            }
        }

        async function verifyCertificate() {
            const certNumber = document.getElementById('verify-input').value.trim();
            const resultDiv = document.getElementById('verify-result');

            if (!certNumber) {
                resultDiv.innerHTML = `
                    <div class="verify-result invalid">
                        <i class="fas fa-exclamation-circle"></i>
                        Please enter a certificate number
                    </div>
                `;
                return;
            }

            resultDiv.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> Verifying...</div>';

            try {
                const response = await fetch(`/api/certificates/verify/${encodeURIComponent(certNumber)}`);

                if (!response.ok) {
                    throw new Error('Verification failed');
                }

                const data = await response.json();

                if (data.valid) {
                    const cert = data.certificate;
                    resultDiv.innerHTML = `
                        <div class="verify-result valid">
                            <h3><i class="fas fa-check-circle"></i> Certificate Valid</h3>
                            <p><strong>Recipient:</strong> ${escapeHtml(cert.student_name)}</p>
                            <p><strong>Title:</strong> ${escapeHtml(cert.title)}</p>
                            <p><strong>Issued:</strong> ${new Date(cert.issue_date).toLocaleDateString()}</p>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="verify-result invalid">
                            <h3><i class="fas fa-times-circle"></i> ${data.status === 'revoked' ? 'Certificate Revoked' : 'Invalid Certificate'}</h3>
                            <p>${escapeHtml(data.message)}</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error verifying certificate:', error);
                resultDiv.innerHTML = `
                    <div class="verify-result invalid">
                        <h3><i class="fas fa-exclamation-triangle"></i> Verification Error</h3>
                        <p>Unable to verify certificate. Please try again later.</p>
                    </div>
                `;
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Event listeners
        document.getElementById('verify-btn').addEventListener('click', verifyCertificate);
        document.getElementById('verify-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                verifyCertificate();
            }
        });

        // Close modal on outside click
        document.getElementById('certificate-modal').addEventListener('click', (e) => {
            if (e.target.id === 'certificate-modal') {
                closeCertificateModal();
            }
        });

        // Check for verify parameter in URL
        const urlParams = new URLSearchParams(window.location.search);
        const verifyParam = urlParams.get('verify');
        if (verifyParam) {
            document.getElementById('verify-input').value = verifyParam;
            setTimeout(() => verifyCertificate(), 500);
        }

        // Initialize
        loadCertificates();
    </script>
</body>
</html>
