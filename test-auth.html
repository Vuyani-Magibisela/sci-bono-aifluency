<!DOCTYPE html>
<html>
<head>
    <title>Auth Debug Tool</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #1a1a1a; color: #0f0; }
        button { background: #0f0; color: #000; padding: 10px 20px; margin: 5px; cursor: pointer; border: none; }
        #output { background: #000; padding: 20px; margin-top: 20px; }
        .error { color: #f00; }
        .success { color: #0f0; }
        .warning { color: #ff0; }
    </style>
</head>
<body>
    <h1>Authentication Debug Tool</h1>

    <button onclick="checkAuth()">Check Auth Status</button>
    <button onclick="clearStorage()">Clear All Storage</button>
    <button onclick="testLogin()">Test Login (Admin)</button>

    <div id="output"></div>

    <script src="js/storage.js"></script>
    <script src="js/api.js"></script>
    <script src="js/auth.js"></script>

    <script>
        const output = document.getElementById('output');

        function log(msg, type = 'info') {
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : '';
            output.innerHTML += `<div class="${className}">${msg}</div>`;
        }

        function checkAuth() {
            output.innerHTML = '<h2>Current Authentication State:</h2>';

            // Raw localStorage check
            log('<b>üì¶ Raw localStorage:</b>');
            log('access_token: ' + (localStorage.getItem('access_token') ? 'EXISTS (length: ' + localStorage.getItem('access_token').length + ')' : 'MISSING'),
                localStorage.getItem('access_token') ? 'success' : 'error');
            log('refresh_token: ' + (localStorage.getItem('refresh_token') ? 'EXISTS' : 'MISSING'),
                localStorage.getItem('refresh_token') ? 'success' : 'error');

            const userStr = localStorage.getItem('user');
            if (userStr) {
                try {
                    const user = JSON.parse(userStr);
                    log('user: ' + JSON.stringify(user, null, 2), 'success');
                } catch (e) {
                    log('user: INVALID JSON - ' + userStr, 'error');
                }
            } else {
                log('user: MISSING', 'error');
            }

            log('token_expiry: ' + localStorage.getItem('token_expiry'));

            // Storage wrapper check
            log('<br><b>üîß Storage.js Functions:</b>');
            log('Storage.get("access_token"): ' + (Storage.get('access_token') ? 'EXISTS' : 'MISSING'));
            const storageUser = Storage.get('user');
            if (storageUser) {
                log('Storage.get("user"): ' + JSON.stringify(storageUser, null, 2), 'success');
            } else {
                log('Storage.get("user"): MISSING', 'error');
            }

            // Auth module check
            log('<br><b>üîê Auth.js Functions:</b>');
            log('Auth.isAuthenticated(): ' + Auth.isAuthenticated(), Auth.isAuthenticated() ? 'success' : 'error');

            const authUser = Auth.getUser();
            if (authUser) {
                log('Auth.getUser(): ' + JSON.stringify(authUser, null, 2), 'success');
                log('Auth.getUserRole(): ' + Auth.getUserRole(), 'warning');
                log('Auth.hasRole("admin"): ' + Auth.hasRole('admin'), Auth.hasRole('admin') ? 'success' : 'error');
                log('Auth.hasRole("student"): ' + Auth.hasRole('student'), Auth.hasRole('student') ? 'error' : 'success');
            } else {
                log('Auth.getUser(): NULL', 'error');
            }

            log('<br><b>üéØ Dashboard URL:</b>');
            log('Auth.getDashboardUrl(): ' + Auth.getDashboardUrl(), 'warning');
        }

        function clearStorage() {
            localStorage.clear();
            sessionStorage.clear();
            output.innerHTML = '<div class="success">‚úÖ All storage cleared!</div>';
        }

        async function testLogin() {
            output.innerHTML = '<h2>Testing Login...</h2>';
            try {
                const result = await Auth.login('admin@sci-bono.org', 'password');
                log('Login result: ' + JSON.stringify(result, null, 2), result.success ? 'success' : 'error');

                setTimeout(() => {
                    checkAuth();
                }, 500);
            } catch (error) {
                log('Login error: ' + error.message, 'error');
            }
        }

        // Auto-run on load
        window.addEventListener('load', () => {
            checkAuth();
        });
    </script>
</body>
</html>
